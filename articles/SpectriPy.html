<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Integrating Spectra with Python's matchms package • SpectriPy</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Integrating Spectra with Python's matchms package">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SpectriPy</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/SpectriPy.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/RforMassSpectrometry/SpectriPy/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Integrating Spectra with Python's matchms package</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/RforMassSpectrometry/SpectriPy/blob/main/vignettes/SpectriPy.Rmd" class="external-link"><code>vignettes/SpectriPy.Rmd</code></a></small>
      <div class="d-none name"><code>SpectriPy.Rmd</code></div>
    </div>

    
    
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><p><strong>Compiled</strong>: Wed Feb 5 13:28:56 2025</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <em>SpectriPy</em> package allows integration of Python MS
packages into a <em>Spectra</em>-based MS analysis in <em>R</em>. Python
functionality is wrapped into R functions allowing a seamless
integration of the functionality of Python’s <em>matchms</em> package
into R. In addition, functions to convert between R’s
<code>Spectra</code> objects and Python’s <em>matchms</em> spectrum
objects are available to the advanced user or developer enabling to
create custom functions or workflows on <code>Spectra</code> objects in
Python and executing them in R using the <em>reticulate</em> R
package.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>If the <em>BiocManager</em> package is not already available, please
install it with <code>install.packages("BiocManager")</code></p>
<p>To install the development version of <em>SpectriPy</em> from GitHub,
please install the <em>remotes</em> package with
`install.packages(“remotes”).</p>
<p>The package requires a python environment to be available and can be
installed with the <em>BiocManager</em> R package using the command
<code>BiocManager::install("RforMassSpectrometry/SpectriPy")</code>.
This will install the latest version of the package from GitHub. All
required python libraries are installed automatically on demand. Note
that first installation or first invocation of specific functions might
take long because of this installation process.</p>
</div>
<div class="section level2">
<h2 id="spectra-similarity-calculations-using-matchms">Spectra similarity calculations using <code>matchms</code><a class="anchor" aria-label="anchor" href="#spectra-similarity-calculations-using-matchms"></a>
</h2>
<p>The <em>SpectriPy</em> package provides the
<code><a href="../reference/compareSpectriPy.html">compareSpectriPy()</a></code> function that allows to perform spectra
similarity calculations using the scoring functions from the
<em>matchms</em> Python package. Below all currently supported scoring
functions are listed along with the <em>parameter</em> class that allows
selecting and configuring the algorithm in the
<code><a href="../reference/compareSpectriPy.html">compareSpectriPy()</a></code> function. Additional functions will be
added in future.</p>
<ul>
<li>
<a href="https://matchms.readthedocs.io/en/latest/api/matchms.similarity.CosineGreedy.html" class="external-link"><em>CosineGreedy</em></a>:
<code>CosineGreedyParam</code>.</li>
<li>
<a href="https://matchms.readthedocs.io/en/latest/api/matchms.similarity.CosineHungarian.html" class="external-link"><em>CosineHungarian</em></a>:
<code>CosineHungarianParam</code>.</li>
<li>
<a href="https://matchms.readthedocs.io/en/latest/api/matchms.similarity.ModifiedCosine.html" class="external-link"><em>ModifiedCosineParam</em></a>:
<code>ModifiedCosineParam</code>.</li>
</ul>
<p>We next create some simple example spectra and subsequently use the
<code><a href="../reference/compareSpectriPy.html">compareSpectriPy()</a></code> function to calculate pairwise
similarities between these.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/SpectriPy" class="external-link">SpectriPy</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Create a Spectra object with two MS2 spectra for Caffeine.</span></span>
<span><span class="va">caf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/DataFrame-class.html" class="external-link">DataFrame</a></span><span class="op">(</span></span>
<span>    msLevel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Caffeine"</span>,</span>
<span>    precursorMz <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">195.0877</span>, <span class="fl">195.0877</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">caf</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">340.0</span>, <span class="fl">416</span>, <span class="fl">2580</span>, <span class="fl">412</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">388.0</span>, <span class="fl">3270</span>, <span class="fl">85</span>, <span class="fl">54</span>, <span class="fl">10111</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">caf</span><span class="op">$</span><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">135.0432</span>, <span class="fl">138.0632</span>, <span class="fl">163.0375</span>, <span class="fl">195.0880</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">110.0710</span>, <span class="fl">138.0655</span>, <span class="fl">138.1057</span>, <span class="fl">138.1742</span>, <span class="fl">195.0864</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">caf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">caf</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Create a Spectra object with two MS2 spectra for 1-Methylhistidine</span></span>
<span><span class="va">mhd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/DataFrame-class.html" class="external-link">DataFrame</a></span><span class="op">(</span></span>
<span>    msLevel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>,</span>
<span>    precursorMz <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">170.0924</span>, <span class="fl">170.0924</span><span class="op">)</span>,</span>
<span>    id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HMDB0000001"</span>, <span class="st">"HMDB0000001"</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1-Methylhistidine"</span>, <span class="st">"1-Methylhistidine"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mhd</span><span class="op">$</span><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">109.2</span>, <span class="fl">124.2</span>, <span class="fl">124.5</span>, <span class="fl">170.16</span>, <span class="fl">170.52</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">83.1</span>, <span class="fl">96.12</span>, <span class="fl">97.14</span>, <span class="fl">109.14</span>, <span class="fl">124.08</span>, <span class="fl">125.1</span>, <span class="fl">170.16</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mhd</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.407</span>, <span class="fl">47.494</span>, <span class="fl">3.094</span>, <span class="fl">100.0</span>, <span class="fl">13.240</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6.685</span>, <span class="fl">4.381</span>, <span class="fl">3.022</span>, <span class="fl">16.708</span>, <span class="fl">100.0</span>, <span class="fl">4.565</span>, <span class="fl">40.643</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mhd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">mhd</span><span class="op">)</span></span></code></pre></div>
<p>We first calculate pairwise similarities between all spectra defined
above and those of caffeine using <em>Spectra</em>’s built-in
<code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra()</a></code> function.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">caf</span>, <span class="va">mhd</span><span class="op">)</span></span>
<span><span class="va">res_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra</a></span><span class="op">(</span><span class="va">all</span>, <span class="va">caf</span><span class="op">)</span></span>
<span><span class="va">res_r</span></span></code></pre></div>
<pre><code><span><span class="co">##           1         2</span></span>
<span><span class="co">## 1 1.0000000 0.1973448</span></span>
<span><span class="co">## 2 0.1973448 1.0000000</span></span>
<span><span class="co">## 3 0.0000000 0.0000000</span></span>
<span><span class="co">## 4 0.0000000 0.0000000</span></span></code></pre>
<p>Thus, <code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra()</a></code> returned the pairwise similarity
scores (by default calculated using the normalized dot-product function)
between all spectra in <code>all</code> (rows) and all spectra in
<code>caf</code> (columns). <code><a href="../reference/compareSpectriPy.html">compareSpectriPy()</a></code> works
similar, with the difference that we need to specify and configure the
similarity function (from <em>matchms</em>) using a dedicated parameter
object. Below we calculate the similarity using the
<em>CosineGreedy</em> function changing the <code>tolerance</code> to a
value of <code>0.05</code> (instead of the default
<code>0.1</code>).</p>
<p>Executing the following step will automatically download and install
conda mini forge to manage Python package dependencies.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compareSpectriPy.html">compareSpectriPy</a></span><span class="op">(</span><span class="va">all</span>, <span class="va">caf</span>, param <span class="op">=</span> <span class="fu"><a href="../reference/compareSpectriPy.html">CosineGreedyParam</a></span><span class="op">(</span>tolerance <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##           [,1]      [,2]</span></span>
<span><span class="co">## [1,] 1.0000000 0.1948181</span></span>
<span><span class="co">## [2,] 0.1948181 1.0000000</span></span>
<span><span class="co">## [3,] 0.0000000 0.0000000</span></span>
<span><span class="co">## [4,] 0.0000000 0.0000000</span></span></code></pre>
<p>As a result <code><a href="../reference/compareSpectriPy.html">compareSpectriPy()</a></code> returns also a numeric
matrix of similarities. Note also that the first
<code><a href="../reference/compareSpectriPy.html">compareSpectriPy()</a></code> call takes usually a little longer
because the Python setup has to be initialized.</p>
<p>Next we use the <em>ModifiedCosine</em> algorithm that considers also
differences between the spectra’s precursor <em>m/z</em> in the
calculation.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compareSpectriPy.html">compareSpectriPy</a></span><span class="op">(</span><span class="va">all</span>, <span class="va">caf</span>, param <span class="op">=</span> <span class="fu"><a href="../reference/compareSpectriPy.html">ModifiedCosineParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##            [,1]      [,2]</span></span>
<span><span class="co">## [1,] 1.00000000 0.1948181</span></span>
<span><span class="co">## [2,] 0.19481813 1.0000000</span></span>
<span><span class="co">## [3,] 0.13841831 0.8520549</span></span>
<span><span class="co">## [4,] 0.05724816 0.3523997</span></span></code></pre>
<p>A third example is the <em>CosineHungarian</em> algorithm, also a
similarity function from <em>matchms</em>. This algorithm calculates the
<em>cosine similarity score</em> as with <code>CosineGreedyParam</code>,
but using the Hungarian algorithm to find the best matching peaks
between the compared spectra. The algorithm can be configured with
parameters <code>tolerance</code>, <code>mzPower</code> and
<code>intensityPower</code> (see parameter description for more
details).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compareSpectriPy.html">compareSpectriPy</a></span><span class="op">(</span><span class="va">all</span>, <span class="va">caf</span>, param <span class="op">=</span> <span class="fu"><a href="../reference/compareSpectriPy.html">CosineHungarianParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##           [,1]      [,2]</span></span>
<span><span class="co">## [1,] 1.0000000 0.1948181</span></span>
<span><span class="co">## [2,] 0.1948181 1.0000000</span></span>
<span><span class="co">## [3,] 0.0000000 0.0000000</span></span>
<span><span class="co">## [4,] 0.0000000 0.0000000</span></span></code></pre>
<p>A fourth example is the <em>NeutralLossesCosine</em> algorithm, also
a similarity function from <em>matchms</em>. The neutral losses cosine
score aims at quantifying the similarity between two mass spectra. The
score is calculated by finding best possible matches between peaks of
two spectra. Two peaks are considered a potential match if their
<em>m/z</em> ratios lie within the given <code>tolerance</code> once a
mass-shift is applied. The mass shift is the difference in
precursor-<em>m/z</em> between the two spectra.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compareSpectriPy.html">compareSpectriPy</a></span><span class="op">(</span><span class="va">all</span>, <span class="va">caf</span>, param <span class="op">=</span> <span class="fu"><a href="../reference/compareSpectriPy.html">NeutralLossesCosineParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##            [,1]       [,2]</span></span>
<span><span class="co">## [1,] 1.00000000 0.04853991</span></span>
<span><span class="co">## [2,] 0.04853991 1.00000000</span></span>
<span><span class="co">## [3,] 0.00000000 0.00000000</span></span>
<span><span class="co">## [4,] 0.00000000 0.00000000</span></span></code></pre>
<p>Note that for the abovementioned similarity calculations all spectra
precursor <em>m/z</em> values need to be available, otherwise an error
will be thrown. Thus, we should always ensure to remove spectra without
precursor <em>m/z</em> values prior to similarity scoring with this
similarity method. Below we remove the precursor <em>m/z</em> from one
of our input spectra and then show how the <code>Spectra</code> object
could be subsetted to <em>valid</em> spectra for this method.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Remove precursor m/z from the 3rd spectrum</span></span>
<span><span class="va">all</span><span class="op">$</span><span class="va">precursorMz</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co">## Filter the input spectra removing those with missing precursor.</span></span>
<span><span class="va">all</span> <span class="op">&lt;-</span> <span class="va">all</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">precursorMz</a></span><span class="op">(</span><span class="va">all</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="../reference/compareSpectriPy.html">compareSpectriPy</a></span><span class="op">(</span><span class="va">all</span>, <span class="va">caf</span>, param <span class="op">=</span> <span class="fu"><a href="../reference/compareSpectriPy.html">ModifiedCosineParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            [,1]      [,2]</span></span>
<span><span class="co">## [1,] 1.00000000 0.1948181</span></span>
<span><span class="co">## [2,] 0.19481813 1.0000000</span></span>
<span><span class="co">## [3,] 0.05724816 0.3523997</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="advanced-use-and-internals">Advanced use and internals<a class="anchor" aria-label="anchor" href="#advanced-use-and-internals"></a>
</h2>
<p>For advanced users or developers, the <code><a href="../reference/rspec_to_pyspec.html">rspec_to_pyspec()</a></code>
and <code><a href="../reference/rspec_to_pyspec.html">pyspec_to_rspec()</a></code> functions are available that enable
conversion between MS data representations in R and Python (i.e. between
the <code><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra::Spectra</a></code> object and the Python
<code>matchms.Spectrum</code> object). To use these functions the
<em>reticulate</em> R package needs to be installed along with a Python
environment and the <em>matchms</em> Python package.</p>
<p>To illustrate their use we initialize below the Python environment
that is bundled using the <em><a href="https://bioconductor.org/packages/3.20/basilisk" class="external-link">basilisk</a></em>
package within <em>SpectriPy</em>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/SpectriPy" class="external-link">SpectriPy</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">basilisk</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: reticulate</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/basilisk/man/basiliskStart.html" class="external-link">basiliskStart</a></span><span class="op">(</span><span class="fu">SpectriPy</span><span class="fu">:::</span><span class="va">matchms_env</span><span class="op">)</span></span></code></pre></div>
<p>We next create a simple <code>Spectra</code> object representing
fragment spectra for some small compounds.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create example spectra</span></span>
<span><span class="va">spd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/DataFrame-class.html" class="external-link">DataFrame</a></span><span class="op">(</span></span>
<span>  msLevel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">2L</span>, <span class="fl">2L</span><span class="op">)</span>,</span>
<span>  id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HMDB0000001"</span>, <span class="st">"HMDB0000001"</span>, <span class="st">"HMDB0001847"</span><span class="op">)</span>,</span>
<span>  name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1-Methylhistidine"</span>, <span class="st">"1-Methylhistidine"</span>, <span class="st">"Caffeine"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Assign m/z and intensity values.</span></span>
<span><span class="va">spd</span><span class="op">$</span><span class="va">mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">109.2</span>, <span class="fl">124.2</span>, <span class="fl">124.5</span>, <span class="fl">170.16</span>, <span class="fl">170.52</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">83.1</span>, <span class="fl">96.12</span>, <span class="fl">97.14</span>, <span class="fl">109.14</span>, <span class="fl">124.08</span>, <span class="fl">125.1</span>, <span class="fl">170.16</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">56.0494</span>, <span class="fl">69.0447</span>, <span class="fl">83.0603</span>, <span class="fl">109.0395</span>, <span class="fl">110.0712</span>,</span>
<span>    <span class="fl">111.0551</span>, <span class="fl">123.0429</span>, <span class="fl">138.0662</span>, <span class="fl">195.0876</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">spd</span><span class="op">$</span><span class="va">intensity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3.407</span>, <span class="fl">47.494</span>, <span class="fl">3.094</span>, <span class="fl">100.0</span>, <span class="fl">13.240</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6.685</span>, <span class="fl">4.381</span>, <span class="fl">3.022</span>, <span class="fl">16.708</span>, <span class="fl">100.0</span>, <span class="fl">4.565</span>, <span class="fl">40.643</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.459</span>, <span class="fl">2.585</span>, <span class="fl">2.446</span>, <span class="fl">0.508</span>, <span class="fl">8.968</span>, <span class="fl">0.524</span>, <span class="fl">0.974</span>, <span class="fl">100.0</span>, <span class="fl">40.994</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">spd</span><span class="op">)</span></span></code></pre></div>
<p>We next convert the <code>Spectra</code> to a
<code>matchms.Spectrum</code> object.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pysps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspec_to_pyspec.html">rspec_to_pyspec</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span>
<span><span class="va">pysps</span></span></code></pre></div>
<pre><code><span><span class="co">## [Spectrum(precursor m/z=nan, 5 fragments between 109.2 and 170.5), Spectrum(precursor m/z=nan, 7 fragments between 83.1 and 170.2), Spectrum(precursor m/z=nan, 9 fragments between 56.0 and 195.1)]</span></span></code></pre>
<p>As a result we got now a Python list with 3 Spectrum objects
containing the peak data of <code>sps</code> as well as a reduced set of
the available spectra variables in <code>sps</code>. Which spectra
variables get copied to Python can be defined with the
<code>mapping</code> parameter of <code>rspec_to_pyspec</code>. The
default is to convert all variables defined by
<code><a href="https://rdrr.io/pkg/Spectra/man/spectraVariableMapping.html" class="external-link">spectraVariableMapping()</a></code>, but additional variables along
with their respective names in the Python Spectrum object can be defined
too. Below we list the pre-selected spectra variables that are converted
by default.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectraVariableMapping.html" class="external-link">spectraVariableMapping</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                  precursorMz           precursorIntensity </span></span>
<span><span class="co">##               "precursor_mz"        "precursor_intensity" </span></span>
<span><span class="co">##              precursorCharge                        rtime </span></span>
<span><span class="co">##                     "charge"             "retention_time" </span></span>
<span><span class="co">##              collisionEnergy      isolationWindowTargetMz </span></span>
<span><span class="co">##           "collision_energy" "isolation_window_target_mz" </span></span>
<span><span class="co">##                      msLevel </span></span>
<span><span class="co">##                   "ms_level"</span></span></code></pre>
<p>With our <code>Spectra</code> data converted to Python, we could
directly call all routines from the <code>matchms</code> package using
the <em>reticulate</em> R package. Below we normalize the intensities of
the 3 spectra using the <code><a href="../reference/filterSpectriPy.html">normalize_intensities()</a></code> function
from the <em>matchms.filtering</em> library. We thus need to first
import the functionality from that package and can then call the
function directly on the (Python) objects.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/reticulate/" class="external-link">reticulate</a></span><span class="op">)</span></span>
<span><span class="va">filters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/reticulate/reference/import.html" class="external-link">import</a></span><span class="op">(</span><span class="st">"matchms.filtering"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pysps</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">pysps</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">res</span><span class="op">[[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">filters</span><span class="op">$</span><span class="fu">normalize_intensities</span><span class="op">(</span><span class="va">pysps</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rstudio.github.io/reticulate/reference/r-py-conversion.html" class="external-link">r_to_py</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">## [Spectrum(precursor m/z=nan, 5 fragments between 109.2 and 170.5), Spectrum(precursor m/z=nan, 7 fragments between 83.1 and 170.2), Spectrum(precursor m/z=nan, 9 fragments between 56.0 and 195.1)]</span></span></code></pre>
<p>We can now convert the list of Python <code>matchms.Spectrum</code>
objects back to R with <code><a href="../reference/rspec_to_pyspec.html">pyspec_to_rspec()</a></code>:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspec_to_pyspec.html">pyspec_to_rspec</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="co">#' The normalized intensities</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">sps_r</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 3</span></span>
<span><span class="co">## [[1]] 0.03407 0.47494 0.03094 1 0.1324</span></span>
<span><span class="co">## [[2]] 0.06685 0.04381 0.03022 0.16708 1 0.04565 0.40643</span></span>
<span><span class="co">## [[3]] 0.00459 0.02585 0.02446 0.00508 0.08968 0.00524 0.00974 1 0.40994</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' The original intensities</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">sps</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 3</span></span>
<span><span class="co">## [[1]] 3.407 47.494 3.094 100 13.24</span></span>
<span><span class="co">## [[2]] 6.685 4.381 3.022 16.708 100 4.565 40.643</span></span>
<span><span class="co">## [[3]] 0.459 2.585 2.446 0.508 8.968 0.524 0.974 100 40.994</span></span></code></pre>
<p>Intensity values have now been normalized to values between 0 and
1.</p>
<p>Note however that, it would be much better (and likely more
efficient) to directly use a Python function on the list of Spectrum
objects instead of the mixed R and Python code used in the example
above. Below we define a simple python script that iterates over the
spectra in python and performs the normalization.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">py_script</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"from matchms.filtering import normalize_intensities\n"</span>,</span>
<span>                    <span class="st">"for i in range(len(pysps)):\n"</span>,</span>
<span>                    <span class="st">"    pysps[i] = normalize_intensities(pysps[i])\n"</span><span class="op">)</span></span>
<span><span class="va">py</span><span class="op">$</span><span class="va">pysps</span> <span class="op">&lt;-</span> <span class="va">pysps</span></span>
<span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_run.html" class="external-link">py_run_string</a></span><span class="op">(</span><span class="va">py_script</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rspec_to_pyspec.html">pyspec_to_rspec</a></span><span class="op">(</span><span class="va">pysps</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">intensity</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NumericList of length 3</span></span>
<span><span class="co">## [[1]] 0.03407 0.47494 0.03094 1 0.1324</span></span>
<span><span class="co">## [[2]] 0.06685 0.04381 0.03022 0.16708 1 0.04565 0.40643</span></span>
<span><span class="co">## [[3]] 0.00459 0.02585 0.02446 0.00508 0.08968 0.00524 0.00974 1 0.40994</span></span></code></pre>
<p>At very last we need also to stop the Python environment enabled by
<em>basilisk</em>.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/basilisk/man/basiliskStart.html" class="external-link">basiliskStop</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.4.2 (2024-10-31)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">## Running under: Ubuntu 24.04.1 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span></span>
<span><span class="co">##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span></span>
<span><span class="co">##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span></span>
<span><span class="co">##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span></span>
<span><span class="co">## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: UTC</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] basilisk_1.18.0     reticulate_1.40.0   SpectriPy_0.2.1    </span></span>
<span><span class="co">## [4] Spectra_1.16.0      BiocParallel_1.40.0 S4Vectors_0.44.0   </span></span>
<span><span class="co">## [7] BiocGenerics_0.52.0 BiocStyle_2.34.0   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] Matrix_1.7-2           jsonlite_1.8.9         compiler_4.4.2        </span></span>
<span><span class="co">##  [4] BiocManager_1.30.25    filelock_1.0.3         Rcpp_1.0.14           </span></span>
<span><span class="co">##  [7] parallel_4.4.2         cluster_2.1.8          jquerylib_0.1.4       </span></span>
<span><span class="co">## [10] png_0.1-8              systemfonts_1.2.1      IRanges_2.40.1        </span></span>
<span><span class="co">## [13] textshaping_1.0.0      yaml_2.3.10            fastmap_1.2.0         </span></span>
<span><span class="co">## [16] lattice_0.22-6         R6_2.5.1               ProtGenerics_1.38.0   </span></span>
<span><span class="co">## [19] knitr_1.49             htmlwidgets_1.6.4      MASS_7.3-64           </span></span>
<span><span class="co">## [22] bookdown_0.42          desc_1.4.3             bslib_0.9.0           </span></span>
<span><span class="co">## [25] rlang_1.1.5            dir.expiry_1.14.0      cachem_1.1.0          </span></span>
<span><span class="co">## [28] xfun_0.50              fs_1.6.5               MsCoreUtils_1.18.0    </span></span>
<span><span class="co">## [31] sass_0.4.9             cli_3.6.3              withr_3.0.2           </span></span>
<span><span class="co">## [34] pkgdown_2.1.1.9000     grid_4.4.2             digest_0.6.37         </span></span>
<span><span class="co">## [37] MetaboCoreUtils_1.14.0 lifecycle_1.0.4        clue_0.3-66           </span></span>
<span><span class="co">## [40] evaluate_1.0.3         codetools_0.2-20       ragg_1.3.3            </span></span>
<span><span class="co">## [43] rmarkdown_2.29         basilisk.utils_1.18.0  tools_4.4.2           </span></span>
<span><span class="co">## [46] htmltools_0.5.8.1</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michael Witting, Johannes Rainer, Carolin Huber, Helge Hecht.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
